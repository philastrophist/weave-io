
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../database-connector/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.14">
    
    
      
        <title>Quickstart by example - WEAVE-IO</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quickstart-by-example" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="WEAVE-IO" class="md-header__button md-logo" aria-label="WEAVE-IO" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WEAVE-IO
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Quickstart by example
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="WEAVE-IO" class="md-nav__button md-logo" aria-label="WEAVE-IO" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    WEAVE-IO
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Outline
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Quickstart by example
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Quickstart by example
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-i-want-to-return-the-number-of-sky-spectra-in-a-given-run-runid1002850" class="md-nav__link">
    1. I want to return the number of sky spectra in a given run (runid=1002850)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1b-i-want-to-see-how-many-sky-targets-each-run-has" class="md-nav__link">
    1b. I want to see how many sky targets each run has
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1c-put-the-above-result-into-a-table-where-i-can-see-the-runid" class="md-nav__link">
    1c. Put the above result into a table where I can see the runid
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-i-want-to-plot-all-single-sky-spectra-from-last-night-in-the-red-arm" class="md-nav__link">
    2. I want to plot all single sky spectra from last night in the red arm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-i-want-to-plot-the-h-alpha-flux-vs-l2-redshift-distribution-from-all-wl-or-w-qso-spectra-that-were-observed-from-all-obs-observed-in-the-past-month-use-the-stacked-data" class="md-nav__link">
    3. I want to plot the H-alpha flux vs. L2 redshift distribution from all WL or W-QSO spectra that were observed from all OBs observed in the past month. Use the stacked data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4a-join-on-a-3rd-party-catalogue" class="md-nav__link">
    4a. Join on a 3rd party catalogue
  </a>
  
    <nav class="md-nav" aria-label="4a. Join on a 3rd party catalogue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ragged-arrays" class="md-nav__link">
    Ragged arrays
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4b-plot-sdss-modelmag_i-from-the-fits-file-against-mean-flux-between-400-450nm" class="md-nav__link">
    4b. Plot sdss modelMag_i from the fits file against mean flux between 400-450nm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-for-each-ob-at-a-time-retrieve-all-the-stacked-red-arm-sky-spectra-and-the-single-spectra-that-went-into-making-those-stacked-spectra" class="md-nav__link">
    5. For each OB at a time, retrieve all the stacked red-arm sky spectra and the single spectra that went into making those stacked spectra
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../user-installation.md" class="md-nav__link">
        User
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../admin-installation.md" class="md-nav__link">
        Admin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../database-connector/" class="md-nav__link">
        The database connector
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Reading
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Reading
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../objects/" class="md-nav__link">
        Objects and their attributes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../building-queries/" class="md-nav__link">
        Building queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tables/" class="md-nav__link">
        Designing result tables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../splitting/" class="md-nav__link">
        Splitting queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stacking/" class="md-nav__link">
        Stacking, aligning, and joining
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../syntax-summary/" class="md-nav__link">
        Syntax summary
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-i-want-to-return-the-number-of-sky-spectra-in-a-given-run-runid1002850" class="md-nav__link">
    1. I want to return the number of sky spectra in a given run (runid=1002850)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1b-i-want-to-see-how-many-sky-targets-each-run-has" class="md-nav__link">
    1b. I want to see how many sky targets each run has
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1c-put-the-above-result-into-a-table-where-i-can-see-the-runid" class="md-nav__link">
    1c. Put the above result into a table where I can see the runid
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-i-want-to-plot-all-single-sky-spectra-from-last-night-in-the-red-arm" class="md-nav__link">
    2. I want to plot all single sky spectra from last night in the red arm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-i-want-to-plot-the-h-alpha-flux-vs-l2-redshift-distribution-from-all-wl-or-w-qso-spectra-that-were-observed-from-all-obs-observed-in-the-past-month-use-the-stacked-data" class="md-nav__link">
    3. I want to plot the H-alpha flux vs. L2 redshift distribution from all WL or W-QSO spectra that were observed from all OBs observed in the past month. Use the stacked data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4a-join-on-a-3rd-party-catalogue" class="md-nav__link">
    4a. Join on a 3rd party catalogue
  </a>
  
    <nav class="md-nav" aria-label="4a. Join on a 3rd party catalogue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ragged-arrays" class="md-nav__link">
    Ragged arrays
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4b-plot-sdss-modelmag_i-from-the-fits-file-against-mean-flux-between-400-450nm" class="md-nav__link">
    4b. Plot sdss modelMag_i from the fits file against mean flux between 400-450nm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-for-each-ob-at-a-time-retrieve-all-the-stacked-red-arm-sky-spectra-and-the-single-spectra-that-went-into-making-those-stacked-spectra" class="md-nav__link">
    5. For each OB at a time, retrieve all the stacked red-arm sky spectra and the single spectra that went into making those stacked spectra
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="quickstart-by-example">Quickstart by example</h1>
<h2 id="1-i-want-to-return-the-number-of-sky-spectra-in-a-given-run-runid1002850">1. I want to return the number of sky spectra in a given run (runid=1002850)</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span> 
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">runid</span> <span class="o">=</span> <span class="mi">1003453</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">nsky</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="n">runid</span><span class="p">]</span><span class="o">.</span><span class="n">targuses</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of sky targets = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsky</span><span class="p">()))</span>
</code></pre></div>
output: <code>number of sky targets = 100</code></p>
<p>We can break this down into several steps:</p>
<ol>
<li><code>from weaveio import *; data = Data()</code> - Import all the necessary <code>weaveio</code> functions and start the default lofar database link (the default is opr3 but this may change in the future).</li>
<li><code>data.</code> - Start building a query using data connection established above</li>
<li><code>data.runs</code> - Get all runs</li>
<li><code>data.runs[runid]</code> - Filter the runs to those that have their id equal to the variable <code>runid</code>. Each run has a unique runid, so you can be sure that this query now contains one row.</li>
<li><code>data.runs[runid].targuses</code> - Each run has multiple L1 single spectra associated with it and each of those spectra have a <code>targuse</code> attribute. Therefore, each run has multiple <code>targuse</code> attributes, therefore you must write <code>targuses</code>. </li>
<li><code>data.runs[runid].targuses == 'S'</code> - Make a boolean mask for where the targuse flag for each spectrum belonging to this run is set to <code>'S'</code> (this refers to "sky").</li>
<li><code>nsky = sum(data.runs[runid].targuses == 'S')</code> - Sum the entire boolean mask, thereby counting the number of sky fibres placed in this run. 
The python function <code>sum</code> was overwritten with a <code>weaveio</code> version when we did our imports. <code>sum</code> is now compatible with <code>weaveio</code> but can also be used normally. </li>
<li><code>nsky()</code> - Up til now, we have been building a query, much like we would write SQL, but nothing has executed on the database yet. 
To run our query and fetch the result, we call it using the parentheses <code>()</code>.</li>
</ol>
<h2 id="1b-i-want-to-see-how-many-sky-targets-each-run-has">1b. I want to see how many sky targets each run has</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">nsky</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">targuses</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="p">)</span>  <span class="c1"># sum the number of sky targets with respect to their runs</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nb">print</span><span class="p">(</span><span class="n">nsky</span><span class="p">())</span>
</code></pre></div>
output: <code>[100 299 299 100 100 200 160 ...]</code></p>
<p>This query is very similar to the previous one except that we are summing over the fibres of each run, not just 1 run as before.
The difference here is that we have missed out <code>data.runs[runid]</code> which means that our query references all <code>runs</code> in the database at once.</p>
<ol>
<li><code>from weaveio import *; data = Data()</code> - Import all the necessary <code>weaveio</code> functions and start the default lofar database link.</li>
<li><code>data.runs</code> - Get all runs.</li>
<li><code>data.runs.targuses == 'S</code> - Access all <code>targuse</code> attributes belonging to each run. Read this statement as "for each run in data, for each targuse in run, do <code>==S</code>.</li>
<li><code>nsky = sum(data.runs.targuses == 'S', wrt=data.runs)</code> - This time sum our boolean mask <em>with respect to (<code>wrt</code>)</em> <code>data.runs</code>. 
This means each row in the resultant query, <code>nsky</code>, will refer to each row in <code>data.runs</code>. I.E. There is now a query row <em>per run</em>, whereas in the previous example there was only one row.</li>
</ol>
<h2 id="1c-put-the-above-result-into-a-table-where-i-can-see-the-runid">1c. Put the above result into a table where I can see the runid</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">nsky</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">targuses</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="p">)</span>  <span class="c1"># sum the number of skytargets with respect to their runs</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">query_table</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">runs</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">nsky</span><span class="p">]]</span>  <span class="c1"># design a table by using the square brackets</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">concrete_table</span> <span class="o">=</span> <span class="n">query_table</span><span class="p">()</span>  <span class="c1"># make it &quot;real&quot; by executing the query</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nb">print</span><span class="p">(</span><span class="n">concrete_table</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">concrete_table</span><span class="p">))</span>
</code></pre></div>
output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>   id   sum0
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>------- ----
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>1003453  100
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>1003440  299
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>...      ...
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>&lt;class &#39;weaveio.readquery.results.Table&#39;&gt;  # although this is an astropy table really
</code></pre></div>
Returning more than one attribute per row requires "designing" a table.
To do this, we put a list of our required values in the square brackets <code>[['id', nsky]]</code>. 
Any string referring to an attribute (e.g. <code>'id'</code>) can go here as well as any previously written query (e.g. <code>nsky</code>').
However, any items that you put in the square brackets must align with the object outside:</p>
<p>For example:
* <code>data.runs[['id', nsky]]</code> is valid because each <code>run</code> has an <code>id</code> and the query <code>nsky</code> is based on <code>data.runs</code> (i.e. each <code>run</code> has an <code>nsky</code> calculated for it).</p>
<h2 id="2-i-want-to-plot-all-single-sky-spectra-from-last-night-in-the-red-arm">2. I want to plot all single sky spectra from last night in the red arm</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">yesterday</span> <span class="o">=</span> <span class="mi">57811</span>  <span class="c1"># state yesterday&#39;s date in MJD</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">runs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">runs</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">is_red</span> <span class="o">=</span> <span class="n">runs</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">is_yesterday</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">runs</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span> <span class="o">==</span> <span class="n">yesterday</span>  <span class="c1"># round down to an integer, which is the day</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="n">runs</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="n">is_red</span> <span class="o">&amp;</span> <span class="n">is_yesterday</span><span class="p">]</span>  <span class="c1"># filter the runs to red ones that were taken yesterday  </span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="n">spectra</span> <span class="o">=</span> <span class="n">runs</span><span class="o">.</span><span class="n">l1single_spectra</span>  <span class="c1"># get all the spectra per run</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="n">sky_spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">spectra</span><span class="o">.</span><span class="n">targuse</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span>  <span class="c1"># filter to the spectra which are sky </span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="n">table</span> <span class="o">=</span> <span class="n">sky_spectra</span><span class="p">[[</span><span class="s1">&#39;wvl&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">]]</span>  <span class="c1"># design a table of wavelength and flux</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="c1"># this may take a while to plot, there is a lot of data</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>  <span class="c1"># you can iterate over a query with `for` as well as requesting the whole thing with `()` </span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># standard matplotlib line plot </span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;sky_spectra.png&#39;</span><span class="p">)</span>
</code></pre></div>
output:</p>
<p><img src="../images/sky_spectra.png" height="200"></p>
<p>The only new thing in this query is <code>for row in table</code>. This implicitly calls the table (<code>table()</code>) and downloads one row at a time. 
You will want to do this when the resulting query will be large. By using this "iterator" pattern, you can avoid loading it all into memory at once.</p>
<h2 id="3-i-want-to-plot-the-h-alpha-flux-vs-l2-redshift-distribution-from-all-wl-or-w-qso-spectra-that-were-observed-from-all-obs-observed-in-the-past-month-use-the-stacked-data">3. I want to plot the H-alpha flux vs. L2 redshift distribution from all WL or W-QSO spectra that were observed from all OBs observed in the past month. Use the stacked data</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">l2s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">l2stacks</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">l2s</span> <span class="o">=</span> <span class="n">l2s</span><span class="p">[(</span><span class="n">l2s</span><span class="o">.</span><span class="n">ob</span><span class="o">.</span><span class="n">mjd</span> <span class="o">&gt;=</span> <span class="mi">57780</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">any</span><span class="p">(</span><span class="n">l2s</span><span class="o">.</span><span class="n">fibre_target</span><span class="o">.</span><span class="n">surveys</span> <span class="o">==</span> <span class="s1">&#39;/WL.*/&#39;</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">l2s</span><span class="o">.</span><span class="n">fibre_target</span><span class="p">)]</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">l2s</span> <span class="o">=</span> <span class="n">l2s</span><span class="p">[</span><span class="n">l2s</span><span class="p">[</span><span class="s1">&#39;ha_6562.80_flux&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">table</span> <span class="o">=</span> <span class="n">l2s</span><span class="p">[[</span><span class="s1">&#39;ha_6562.80_flux&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;ha_6562.80_flux&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;ha-z.png&#39;</span><span class="p">)</span> 
</code></pre></div>
<p><img src="../images/ha-z.png" height="200"></p>
<p>Let's break down this query:</p>
<ol>
<li><code>l2s = data.l2stacks</code> gets all l2stack products in the database. These are the data products which contain joined spectra and template fits.</li>
<li><code>l2s.fibre_target.surveys == '/WL.*/'</code> - This creates a boolean mask matching the survey name to 'WL.*' with regex. You can activate regex by using <code>/</code> at the start and end of a string.</li>
<li><code>l2s = l2s[(l2s.ob.mjd &gt;= 57780) &amp; any(l2s.fibre_target.surveys == '/WL.*/', wrt=l2s.fibre_target)]</code> - This filters to l2 products whose L1 observations were taken after 57780
and survey names containing "WL"</li>
<li><code>l2s = l2s[l2s['ha_6562.80_flux'] &gt; 0]</code> - Then we further filter the l2 products by required an halpha flux greater than 0 (fit by Gandalf).</li>
<li><code>l2s[['ha_6562.80_flux', 'z']]</code> - This designs a table with the halpha flux (from gandalf) and the redshift (from redrock)</li>
</ol>
<h2 id="4a-join-on-a-3rd-party-catalogue">4a. Join on a 3rd party catalogue</h2>
<p>Given a catalogue of weave cnames, find those objects in the database and return the calendar dates on which those matched objects were observed, and the number of WEAVE visits to each CNAME (there could be more than one)</p>
<p>To do this we need to use <code>join</code> which is imported from <code>weaveio</code>. 
<code>join</code> takes at least 3 arguments: the first is the table to join on, the second is the column name in that table, and the third is the object in <code>weaveio</code> to join to.
You may also specify a <code>join_query</code> which is another <code>weaveio</code> query that results in the attribute to join to. If this is not specified, then it is assumed that the attribute should be the same as the column name in the table.
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">index_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>         <span class="n">object_query</span><span class="p">:</span> <span class="n">ObjectQuery</span><span class="p">,</span> <span class="n">join_query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AttributeQuery</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>         <span class="n">join_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TableVariableQuery</span><span class="p">,</span> <span class="n">ObjectQuery</span><span class="p">]:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="o">...</span>
</code></pre></div>
The output of <code>join</code> is the input table converted to a <code>weaveio</code> variable and a reduced version of the input <code>object_query</code>.
The output table variable should now be treated as rows.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span> <span class="nn">weaveio</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">weaveio</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;tests/my_table.ascii&#39;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">rows</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;cname&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">weave_targets</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">mjds</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">exposures</span><span class="o">.</span><span class="n">mjd</span>  <span class="c1"># get the mjd of the plate exposures for each target</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">q</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="s1">&#39;cname&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;modelMag_i&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;mjds&#39;</span><span class="p">:</span> <span class="n">mjds</span><span class="p">,</span> <span class="s1">&#39;nobservations&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">(</span><span class="n">mjds</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">targets</span><span class="p">)}]</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">())</span>
</code></pre></div>
output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>       cname         modelMag_i          mjds [15]           nobservations
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>-------------------- ---------- ---------------------------- -------------
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>WVE_10461805+5755400   20.20535 57809.109711 .. 57811.075961            15
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>WVE_10521675+5814292    21.2665 57809.109711 .. 57811.075961            15
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>WVE_10521675+5814292    21.2665 57809.109711 .. 57811.075961            15
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>WVE_02175674-0451074   21.38155             57640.1764 .. --             6
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>WVE_02174727-0459587   21.81214             57640.1764 .. --             6
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>WVE_02175411-0504122   22.28189             57640.1764 .. --             6
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>WVE_02175687-0512209   21.79577             57640.1764 .. --             6
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>WVE_02174991-0454427   21.65417             57640.1764 .. --             6
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>WVE_02175370-0448267   19.63735             57640.1764 .. --             6
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>WVE_02174862-0457336     22.181             57640.1764 .. --             6
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>WVE_02175320-0508011   20.16733             57640.1764 .. --             6
</code></pre></div>
Breaking down this query:
1. <code>table = Table.read('weaveio/tests/my_table.ascii', format='ascii')</code> - This reads in a custom table from the file <code>my_table.ascii</code>. One of the column names is <code>cname</code>.
2. <code>rows, targets = join(table, 'cname', data.weave_targets)</code> - This joins the <code>cname</code> column of the table to the <code>cname</code> attribute of the weave targets catalogue.
<code>targets</code> will refer to all <code>weave_targets</code> that were matched by the <code>cname</code> column and <code>rows</code> will refer to the rows of the table.
3. <code>mjds = targets.exposures.mjd</code> - This gets the mjd of the plate exposures for each target (there may be more than 1) and each exposure will have 2 <code>l1single_spectra</code> (one for each arm), although we don't worry about that yet. 
4. <code>q = targets['cname', rows['modelMag_i'], {'mjds': mjds, 'nobservations': count(mjds, wrt=targets)}]</code> - This creates a table using the 'modelMag_i' found in the fits file table. This can be done because we joined it earlier.
Here we are also renaming columns to more human readable names using a dictionary. </p>
<h3 id="ragged-arrays">Ragged arrays</h3>
<p>The mjd result column is "ragged" array since there may be more than 1 exposure per target and that is not constant for each target.
So that the user can aggregate easily we convert the mjd result column to a regular array and mask it.</p>
<h2 id="4b-plot-sdss-modelmag_i-from-the-fits-file-against-mean-flux-between-400-450nm">4b. Plot sdss modelMag_i from the fits file against mean flux between 400-450nm</h2>
<p>Continuing from 4a, we first traverse to the <code>l1single_spectra</code> and fetch their wavelengths and fluxes.
Then we plot the modelMag_i from the fits file against the mean flux between 400-450nm.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">q</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">l1single_spectra</span><span class="p">[[</span><span class="s1">&#39;cname&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;modelMag_g&#39;</span><span class="p">],</span> <span class="s1">&#39;wvl&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;sensfunc&#39;</span><span class="p">]]</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">table</span> <span class="o">=</span> <span class="n">q</span><span class="p">()</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">mean_fluxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wvl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wvl&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4500</span><span class="p">)</span>  <span class="c1"># angstroms</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">mean_fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">filt</span><span class="p">]))</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">table</span><span class="p">[</span><span class="s1">&#39;mean_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_fluxes</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;mean_flux&#39;</span><span class="p">])</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;modelMag_g&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;mean_flux&#39;</span><span class="p">]))</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>      mean_flux      
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>---------------------
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>   1.6613570457103553
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>   1.8225295509082666
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>   1.6668027617324288
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>                   --
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>   1.8113559953805027
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>                   --
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    1.685038564203977
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>                  ...
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>                   --
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a> -0.07946323931008473
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>                   --
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>-0.012973852190988072
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a> -0.13294200506014725
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>                   --
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>                   --
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>Length = 90 rows
</code></pre></div>
<img src="../images/mean_flux_gband.png" height="200"></p>
<h2 id="5-for-each-ob-at-a-time-retrieve-all-the-stacked-red-arm-sky-spectra-and-the-single-spectra-that-went-into-making-those-stacked-spectra">5. For each OB at a time, retrieve all the stacked red-arm sky spectra and the single spectra that went into making those stacked spectra</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span> <span class="nn">weaveio</span> <span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">()</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">obs</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span>  <span class="c1"># mark the fact that you want have one table per OB thereby &quot;splitting&quot; the query in to multiple queries</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">stacks</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">l1stack_spectra</span><span class="p">[(</span><span class="n">obs</span><span class="o">.</span><span class="n">l1stack_spectra</span><span class="o">.</span><span class="n">targuse</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">l1stack_spectra</span><span class="o">.</span><span class="n">camera</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">)]</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">singles</span> <span class="o">=</span> <span class="n">stacks</span><span class="o">.</span><span class="n">l1single_spectra</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">singles_table</span> <span class="o">=</span>  <span class="n">singles</span><span class="p">[[</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;ivar&#39;</span><span class="p">]]</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">query</span> <span class="o">=</span> <span class="n">stacks</span><span class="p">[[</span><span class="s1">&#39;ob.id&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;stack_flux&#39;</span><span class="p">:</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;stack_ivar&#39;</span><span class="p">:</span> <span class="s1">&#39;ivar&#39;</span><span class="p">},</span> <span class="s1">&#39;wvl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;single_&#39;</span><span class="p">:</span> <span class="n">singles_table</span><span class="p">}]]</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ob_query</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stacks and singles for OB #</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob_query</span><span class="p">())</span>
</code></pre></div>
output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>stacks and singles for OB #3133:
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>ob.id stack_flux [15289] ... single_flux [3,15289] single_ivar [3,15289]
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>----- ------------------ ... --------------------- ---------------------
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a> 3133         0.0 .. 0.0 ...            0.0 .. 0.0            0.0 .. 0.0
</code></pre></div>
Breaking down this query:</p>
<p>There are two new concepts in this example: query splitting and adding tables together.</p>
<ol>
<li>Splitting occurs with <code>obs = split(data.obs)</code>. 
Nothing special happens here except that we have now marked that any query that follows from <code>obs</code> will yield more than one table.
Each table will have a different <code>ob.id</code> value</li>
<li>We continue our query as normal</li>
<li><code>query = stacks[['ob.id', {'stack_flux': 'flux', 'stack_ivar': 'ivar'}, 'wvl', {'single_': singles_table}]]</code> - Here we have now added the <code>singles_table</code> into a new table we are constructing.
This is equivalent to <code>query = stacks[['ob.id', {'stack_flux': 'flux', 'stack_ivar': 'ivar'}, 'wvl', {'single_flux': singles['flux'], 'single_ivar': singles['ivar']}]]</code>. 
When renaming the additional table (with <code>{'single_': ...}</code>) we are added a prefix onto each of the new columns.</li>
<li><code>for index, ob_query in query:</code> - <code>query</code> is now split query, so when we iterate over it we get one table for each ob.id value. 
It also returns an index, which in this case is just the <code>ob.id</code> value. <code>ob_query</code> is now identical to the original <code>query</code> except that is will only return results for one OB.</li>
<li><code>ob_query()</code> - Execute the query only for the current OB (the one with <code>ob.id == index</code>).</li>
</ol>
<p><code>split</code> is the equivalent function to <code>group_by</code> in pandas or astropy. However, you must perform a <code>split</code> before querying whereas in a pandas/astropy <code>group_by</code> it is done after the fact.</p>
<p>Also, it is important to note that the <code>single_flux</code> and <code>single_ivar</code> columns are 2 dimensional since there are 3 single spectra per stack spectrum. 
So you get all 3 at once, per row of the query.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>